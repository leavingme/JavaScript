var FileManager=new function(){var b={};this.getCache=function(c){return b[c]};this.setCache=function(d,c){b[d]=c};this.deleteCache=function(f){delete b[f];var c=document.getElementById(f);if(c){try{c.innerHTML=""}catch(d){}try{c=c.parentNode.removeChild(c)}catch(d){c=document.body.removeChild(c)}finally{delete c}}};this.clearCache=function(){for(var c in b){this.deleteCache(c)}};var a=function(){return"?_t="+new Date().getTime()};this.load=function(c,d,e){if(b[c]){e(b[c],c)}else{$.get(d+a(),function(f){b[c]=f;e(f,c);f=null;delete f})}};this.loadHtml=function(c,d,e){if(!b[c]){$.get(d+a(),function(g,f){b[c]=g;e(b[c],c);g=null;delete g})}else{e(b[c],c)}};this.loadJs=function(d,f,g){if(!b[d]){var c=false;var e=document.createElement("script");e.onload=e.onreadystatechange=function(){if(!c&&(!this.readyState||this.readyState=="loaded"||this.readyState=="complete")){c=true;b[d]=e;g(b[d],d)}};e.id=d;e.type="text/javascript";e.src=f;document.getElementsByTagName("head")[0].appendChild(e)}else{g(b[d],d)}};this.loadCss=function(d,e,f){if(!b[d]){var c=document.createElement("link");c.id=d;c.type="text/css";c.rel="stylesheet";c.href=e+a();document.getElementsByTagName("head")[0].appendChild(c);b[d]=c}f(b[d],d)}};$.fm=FileManager;var EventManager=new function(){var a=function(c,d){this._name=c;this._handler=d||function(){};this._delegate=[]};$.extend(a.prototype,new function(){this.add=function(c){this._delegate.push(c)};this.handler=function(){return this._handler.apply(window,arguments)};this.trigger=function(){var c=arguments;for(var f=0;f<this._delegate.length;f++){var h=this._delegate[f];try{h.apply(window,c)}catch(g){}}}});var b={};this.bind=function(c,d){var e=this;b[c]=new a(c,d.handler);d.event&&d.event(c,function(){var f=$.makeArray(arguments);e.trigger(c,null,f)})};this.delegate=function(c,d){var e=b[c];if(!e){e=new a(c);b[c]=e}e.add(d)};this.trigger=function(d,e,c){var f=b[d];if(!f){f=new a(d);b[d]=f}c=c||[];f.handler.apply(f,c);if(e){e.apply(window,c)}else{f.trigger.apply(f,c)}}};$.em=EventManager;var AppManager=new function(){var a=function(e,g,d,i,h,f){this._mem=$.extend({html:{},css:{},js:{}});this._name=e;this._uid=g;this._wrapperEl=d;this._floatWrapperEl=i;this._containerEl=h;this._statusEl=f;this._path=$.am.getAppPath()+e+"/";this._is_install=false;this._is_load=false;this._is_current=false;this._is_floating=false;this._is_error=false;this._is_history=true};$.extend(a.prototype,new function(){var f=function(n,o,p){n=n+"-html";$.fm.loadHtml(n,o,p)};var i=function(n){n=n+"-html";$.fm.deleteCache(n)};var d=function(n,o,p){n=n+"-css";$.fm.loadCss(n,o,p)};var e=function(n){n=n+"-css";$.fm.deleteCache(n)};var h=function(n,o,p){n=n+"-js";$.fm.loadJs(n,o,p)};var g=function(n){n=n+"-js";$.fm.deleteCache(n)};var m=function(o,n){o&&o.attr("class",n)};var l=function(o,n){o&&o.addClass(n)};var k=function(o,n){o&&o.removeClass(n)};this.loading=function(){l(this._wrapperEl,"loading")};this.unloading=function(){k(this._wrapperEl,"loading")};this.fatalerror=function(){m(this._wrapperEl,"fatalerror")};this.status=function(n){this._statusEl&&this._statusEl.find("#"+this._name+"-status").html(n||"")};this.offline=function(o){var n="apps/homepage/offline.html";$(o).attr("src",n)};this.is=function(o,n){if(typeof n=="undefined"){return this["_is_"+o]}else{this["_is_"+o]=n}};this.install=function(){var s=this;if(!this._is_install){var n=this._name;var q=null;var p=null;var r=null;if(s._containerEl){this.loadHtml("main",function(u){if(u){if(s._containerEl){var t=document.createElement("div");t.id=s._name+"-app";t.className="perapp";t.innerHTML=u;s._containerEl[0].appendChild(t)}if(s._statusEl){t=document.createElement("div");t.id=s._name+"-status";t.className="perstatus";s._statusEl[0].appendChild(t)}}q=true})}else{q=true}this.loadCss("main",function(t){p=true});this.loadJs("main",function(t){r=true});var o=setInterval(function(){if(!o){return}if(q&&p&&r){clearInterval(o);o=null;s._is_install=true}},100)}return this};this.uninstall=function(){if(this._is_install){for(var n in this_mem.html){i(this_mem.html[n])}for(var n in this_mem.css){e(this_mem.css[n])}for(var n in this_mem.js){g(this_mem.js[n])}this._is_install=false}return this};this._lazy=function(r,o,n,p){var s=this;if(this._is_install==o&&this._is_load==n){r.apply(this,p)}else{var q=setInterval(function(){if(!q){return}if(s._is_install==o&&s._is_load==n){clearInterval(q);q=null;r.apply(s,p)}},100)}};this.load=function(){if(!this._is_load){this._lazy(function(){this._mem.load&&this._mem.load.apply(this,arguments);this._is_load=true},true,false,arguments)}return this};this.reload=function(){this._is_load=false;return this.load()};this.unload=function(){if(this._is_load){this._mem.unload&&this._mem.unload.apply(this,arguments);this._is_load=false}return this};this.show=function(){$.am.setCurrentApp(this);this._lazy(function(){m(this._wrapperEl,this._name);m(this._floatWrapperEl,"");this._mem.show&&this._mem.show.apply(this,arguments)},true,true,arguments);return this};this.floating=function(){$.am.setFloatApp(this);this._lazy(function(){m(this._floatWrapperEl,this._name+" float-app");this._is_floating=true;this._mem.floating&&this._mem.floating.apply(this,arguments)},true,true,arguments);return this};this.unfloating=function(){if(this._is_floating){m(this._floatWrapperEl,"");this._is_floating=false;this._mem.unfloating&&this._mem.unfloating.apply(this,arguments)}return this};var j=function(r,n,o){if(n.indexOf("http://")==0){var p=n;var n=encodeURIComponent(n);var q=r._uid+"-"+n}else{var p=r._path+n+"."+o;var q=r._uid+"-"+n}r._mem[o][n]=q;return{name:n,path:p,id:q}};this.loadHtml=function(n,r){var o=j(this,n,"html");var q=this;f(o.id,o.path,function(){r&&r.apply(q,arguments)});return this};this.loadCss=function(n,r){var o=j(this,n,"css");var q=this;d(o.id,o.path,function(){r&&r.apply(q,arguments)});return this};this.loadJs=function(n,r){var o=j(this,n,"js");var q=this;h(o.id,o.path,function(){r&&r.apply(q,arguments)});return this}});var c=0;var b={apps:{},mem:{},appPath:"./apps/",c_app:null,l_app:null,f_app:null,c_uid:0};this.setMem=function(d,e){b.mem[d]=e};this.getMem=function(d){return b.mem[d]};this.setAppPath=function(d){b.appPath=d};this.getAppPath=function(){return b.appPath};this.isCurrentApp=function(d){if(typeof d=="string"){return b.apps[d]&&b.apps[d].is("current")}else{if(typeof d=="object"){return d&&d.is("current")}}};this.setCurrentApp=function(d){if(b.c_app==null||d._name!=b.c_app._name){if(b.c_app&&b.c_app._is_history){b.l_app=b.c_app;b.l_app.is("current",false)}b.c_app=d;b.c_app.is("current",true)}};this.getCurrentApp=function(){return b.c_app};this.setLastApp=function(d){b.l_app=d};this.getLastApp=function(){return b.l_app};this.setFloatApp=function(d){b.f_app=d};this.getFloatApp=function(){return b.f_app};this.getApp=function(d){return b.apps[d]};this.installApp=function(d,f){if(b.apps[d]){var g=b.apps[d]}else{f=f||{};var e=new String(new Date().getTime()).replace(/(\d{4})(\d{4})(\d{5})/,"$1-$2-$3")+"-"+(b.c_uid++);var g=new a(d,e,f.wrapperEl,f.floatWrapperEl,f.containerEl,f.statusEl);b.apps[d]=g;g.install()}return g};this.uninstallApp=function(d){var e=b.apps[d];if(e){delete b.apps[d];if(e){e.uninstall()}delete e}};this.extendApp=function(d,e){var f=this.getApp(d);for(var g in e){f._mem[g]=e[g];if(typeof e[g]=="function"&&!f[g]){f[g]=(function(h){return function(){return f._mem[h].apply(f,arguments)}})(g)}else{if(typeof e[g]!="function"){f[g]=f._mem[g]}}}return f};this.reloadApp=function(d){if(d){var e=b.apps[d]}else{var e=b.c_app}if(e){e.reload()}return e}};$.am=AppManager;var RunManager={};RunManager.run=function(d,c){var b=arguments;var e=c.app_name;var a="";if(c.app_id){a=c.app_id}else{if(c.kkrs){a=c.kkrs.substr(c.kkrs.indexOf("appid=")+6,36)}}switch(d){case"kkrs":client_api.kkrs(c.kkrs,c.mid,c.sid);break;case"recent":client_api.run_recent_app(c.kkrs,c.mid,c.sid);break;case"flash":client_api.run_flash(a,c.run_flash_base64,c.name_base64,c.mid,c.sid);break;case"download":window.open(c.download_url);break;case"normal":case"":default:client_api.run(a,c.shortcut_target,e,c.mid,c.sid);break}};RunManager.cmd=function(h){try{var l="";var b={};var a=h.isFunction;var g=h.app;var j=h.shortcut;var q=h.mid;var c=h.sid;var m=g.app_id;var d=g.shortcut_name;var i=g.app_name;var s=g.name;i=(d||i||s||"")+"";i=i.replace(/[(\uff08].*[\uff09)]/,"").replace(".lnk","");var f=parseInt(g.category_second_id);var n=g.package_type;if(f==300){var k=g.name_base64;var r=g.run_flash_base64;b={app_id:m,app_name:i,name_base64:k,run_flash_base64:r,mid:q,sid:c};if(a){l=function(){RunManager.run("flash",b)}}else{strOpt=JSON.stringify(b);strOpt=strOpt.replace(/\"/g,"'");l="RunManager.run('flash', "+strOpt+")"}}else{var p=g.shortcut_target;p=(p||(j&&j.shortcut_target))||"";b={app_id:m,app_name:i,shortcut_target:p,mid:q,sid:c};if(a){l=function(){RunManager.run("normal",b)}}else{strOpt=JSON.stringify(b);strOpt=strOpt.replace(/\"/g,"'");l="RunManager.run('normal', "+strOpt+")"}}}catch(o){alert("error cmd: "+o.message)}return l};
